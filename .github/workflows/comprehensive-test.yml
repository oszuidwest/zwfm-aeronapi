name: Comprehensive Test
permissions:
  contents: read
on:
  pull_request:
    branches: [main]
  workflow_call:
    inputs:
      skip_tests:
        description: 'Skip tests (for edge releases)'
        type: boolean
        required: false
        default: false
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (for edge releases)'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  POSTGRES_USER: aeron
  POSTGRES_PASSWORD: aeron123
  POSTGRES_DB: aeron_db
  API_PORT: 8888
  DB_PORT: 5433
  API_KEY: test-api-key-12345
  # Known IDs from test fixtures
  ARTIST_ID: "9e37ff1f-7823-43ce-93d0-12fc1c2edb8b"
  BLOF_ID: "add55a6e-2068-4114-b82a-e0729881f0be"
  FAKE_UUID: "00000000-0000-4000-8000-000000000001"

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build application
        run: |
          go build -ldflags="-X main.Version=test -X main.Commit=${{ github.sha }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o zwfm-aerontoolbox .
          ./zwfm-aerontoolbox -version

      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: binary
          path: zwfm-aerontoolbox
          retention-days: 1

  lint:
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Check formatting (gofmt)
        run: |
          UNFORMATTED=$(gofmt -s -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "::error::De volgende bestanden zijn niet correct geformatteerd:"
            echo "$UNFORMATTED"
            exit 1
          fi
          echo "Alle bestanden zijn correct geformatteerd"

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

      - name: Check for dead code
        run: go run golang.org/x/tools/cmd/deadcode@latest ./...

      - name: Run govulncheck
        run: go run golang.org/x/vuln/cmd/govulncheck@latest ./...

  integration:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}
    strategy:
      fail-fast: false
      matrix:
        suite:
          - database
          - api-basic
          - artists
          - tracks
          - maintenance
          - backup
          - edge-cases

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binary
        uses: actions/download-artifact@v7
        with:
          name: binary

      - name: Make binary executable
        run: chmod +x ./zwfm-aerontoolbox

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq imagemagick postgresql-client

      - name: Start test database
        run: |
          cd tests
          docker compose -f docker-compose.test.yml up -d

      - name: Wait for database
        run: |
          echo "Wachten op database..."
          for i in {1..30}; do
            if docker exec aeron-test-db pg_isready -U aeron 2>/dev/null; then
              sleep 2
              break
            fi
            sleep 1
          done
          ARTIST_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist;" 2>/dev/null | tr -d ' ')
          echo "Database klaar - $ARTIST_COUNT artiesten geladen"
          [ -n "$ARTIST_COUNT" ] && [ "$ARTIST_COUNT" -gt 0 ]

      - name: Create test configuration
        run: |
          cat > test_config.json << 'EOF'
          {
            "database": {
              "host": "localhost",
              "port": "5433",
              "name": "aeron_db",
              "user": "aeron",
              "password": "aeron123",
              "schema": "aeron",
              "sslmode": "disable"
            },
            "image": {
              "target_width": 1280,
              "target_height": 1280,
              "quality": 90,
              "reject_smaller": true
            },
            "api": {
              "enabled": true,
              "keys": ["test-api-key-12345", "another-test-key-67890"]
            },
            "backup": {
              "enabled": true,
              "path": "/tmp/backups",
              "retention_days": 30,
              "max_backups": 5,
              "default_format": "custom",
              "default_compression": 9
            }
          }
          EOF
          mkdir -p /tmp/backups

      - name: Create test images
        if: matrix.suite == 'artists' || matrix.suite == 'tracks' || matrix.suite == 'edge-cases'
        run: |
          convert -size 100x100 xc:red test_small.png
          convert -size 2000x2000 xc:blue test_large.png
          echo "Test images aangemaakt (100x100 en 2000x2000)"

      - name: Start API server
        run: |
          ./zwfm-aerontoolbox -config=test_config.json -port=${{ env.API_PORT }} &
          echo $! > api.pid
          for i in {1..30}; do
            curl -sf http://localhost:${{ env.API_PORT }}/api/health > /dev/null 2>&1 && break
            sleep 1
          done
          echo "API server gestart op poort ${{ env.API_PORT }}"

      # ==================== DATABASE TESTS ====================
      - name: "Database: Schema exists"
        if: matrix.suite == 'database'
        run: |
          echo "Controleren of 'aeron' schema bestaat..."
          RESULT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t \
            -c "SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'aeron';")
          if echo "$RESULT" | grep -q 'aeron'; then
            echo "Schema 'aeron' gevonden"
          else
            echo "::error::Schema 'aeron' niet gevonden"
            exit 1
          fi

      - name: "Database: Required tables exist"
        if: matrix.suite == 'database'
        run: |
          echo "Controleren of vereiste tabellen bestaan..."
          for TABLE in artist track; do
            RESULT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t \
              -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'aeron' AND table_name = '$TABLE';")
            if echo "$RESULT" | grep -q "$TABLE"; then
              echo "Tabel '$TABLE' gevonden"
            else
              echo "::error::Tabel '$TABLE' niet gevonden"
              exit 1
            fi
          done

      - name: "Database: Verify data counts"
        if: matrix.suite == 'database'
        run: |
          ARTIST_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist;" | tr -d ' ')
          TRACK_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.track;" | tr -d ' ')
          ARTISTS_WITH_IMG=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist WHERE picture IS NOT NULL;" | tr -d ' ')

          echo "Artiesten: $ARTIST_COUNT (verwacht: 1000)"
          echo "Tracks: $TRACK_COUNT (verwacht: 1100)"
          echo "Artiesten met afbeelding: $ARTISTS_WITH_IMG (verwacht: >0)"

          FAILED=0
          [ "$ARTIST_COUNT" -ne 1000 ] && echo "::error::Aantal artiesten klopt niet" && FAILED=1
          [ "$TRACK_COUNT" -ne 1100 ] && echo "::error::Aantal tracks klopt niet" && FAILED=1
          [ "$ARTISTS_WITH_IMG" -le 0 ] && echo "::error::Geen artiesten met afbeelding" && FAILED=1
          exit $FAILED

      # ==================== API BASIC TESTS ====================
      - name: "API: Health endpoint"
        if: matrix.suite == 'api-basic'
        run: |
          echo "GET /api/health"
          RESPONSE=$(curl -s http://localhost:${{ env.API_PORT }}/api/health)
          echo "Response: $RESPONSE"
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Health check OK"
          else
            echo "::error::Health check gefaald - success=$SUCCESS"
            exit 1
          fi

      - name: "API: Authentication required"
        if: matrix.suite == 'api-basic'
        run: |
          echo "GET /api/artists (zonder API key)"
          RESPONSE=$(curl -s http://localhost:${{ env.API_PORT }}/api/artists)
          echo "Response: $RESPONSE"
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: request zonder API key wordt geweigerd"
          else
            echo "::error::Request zonder API key zou geweigerd moeten worden"
            exit 1
          fi

      - name: "API: Valid API key accepted"
        if: matrix.suite == 'api-basic'
        run: |
          echo "GET /api/artists (met geldige API key)"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/artists)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          TOTAL=$(echo "$RESPONSE" | jq -r '.data.total')
          if [ "$SUCCESS" = "true" ]; then
            echo "Correct: API key geaccepteerd - $TOTAL artiesten gevonden"
          else
            echo "::error::Geldige API key werd niet geaccepteerd"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "API: Invalid API key rejected"
        if: matrix.suite == 'api-basic'
        run: |
          echo "GET /api/artists (met ongeldige API key)"
          RESPONSE=$(curl -s -H 'X-API-Key: invalid-key' http://localhost:${{ env.API_PORT }}/api/artists)
          echo "Response: $RESPONSE"
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: ongeldige API key wordt geweigerd"
          else
            echo "::error::Ongeldige API key zou geweigerd moeten worden"
            exit 1
          fi

      - name: "API: Method not allowed returns 405"
        if: matrix.suite == 'api-basic'
        run: |
          echo "PUT /api/artists (niet toegestane methode)"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/artists)
          echo "HTTP status: $HTTP_CODE (verwacht: 405)"
          if [ "$HTTP_CODE" = "405" ]; then
            echo "Correct: PUT methode geeft 405 Method Not Allowed"
          else
            echo "::error::Verwachtte HTTP 405, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "API: Invalid endpoint returns 404"
        if: matrix.suite == 'api-basic'
        run: |
          echo "GET /api/invalid (niet-bestaand endpoint)"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/invalid)
          echo "HTTP status: $HTTP_CODE (verwacht: 404)"
          if [ "$HTTP_CODE" = "404" ]; then
            echo "Correct: ongeldig endpoint geeft 404 Not Found"
          else
            echo "::error::Verwachtte HTTP 404, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "API: Playlist endpoint"
        if: matrix.suite == 'api-basic'
        run: |
          echo "Playlist data bijwerken naar vandaag..."
          docker exec aeron-test-db psql -U aeron -d aeron_db -c "UPDATE aeron.playlistitem SET startdatetime = CURRENT_DATE + (startdatetime::time)" > /dev/null
          echo "GET /api/playlist"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/playlist)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          BLOCKS=$(echo "$RESPONSE" | jq '.data | length')
          if [ "$SUCCESS" = "true" ]; then
            echo "Correct: playlist opgehaald met $BLOCKS blokken"
          else
            echo "::error::Playlist endpoint gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "API: Playlist block structure"
        if: matrix.suite == 'api-basic'
        run: |
          echo "Controleren of playlist blokken de juiste velden hebben..."
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/playlist)
          REQUIRED_FIELDS="blockid name start_time end_time date tracks"
          FIRST_BLOCK=$(echo "$RESPONSE" | jq '.data[0]')
          echo "Eerste blok: $FIRST_BLOCK"
          for FIELD in $REQUIRED_FIELDS; do
            if echo "$FIRST_BLOCK" | jq -e "has(\"$FIELD\")" > /dev/null; then
              echo "Veld '$FIELD' aanwezig"
            else
              echo "::error::Verplicht veld '$FIELD' ontbreekt in playlist blok"
              exit 1
            fi
          done

      - name: "API: Playlist track structure"
        if: matrix.suite == 'api-basic'
        run: |
          echo "Controleren of playlist tracks de juiste velden hebben..."
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/playlist)
          REQUIRED_FIELDS="trackid tracktitle artistid artistname start_time"
          FIRST_TRACK=$(echo "$RESPONSE" | jq '.data[0].tracks[0]')
          echo "Eerste track: $FIRST_TRACK"
          for FIELD in $REQUIRED_FIELDS; do
            if echo "$FIRST_TRACK" | jq -e "has(\"$FIELD\")" > /dev/null; then
              echo "Veld '$FIELD' aanwezig"
            else
              echo "::error::Verplicht veld '$FIELD' ontbreekt in playlist track"
              exit 1
            fi
          done

      - name: "API: Auth disabled mode"
        if: matrix.suite == 'api-basic'
        run: |
          echo "API server herstarten zonder authenticatie..."
          kill $(cat api.pid) 2>/dev/null || true
          cat > test_no_auth.json << 'EOF'
          {
            "database": { "host": "localhost", "port": "5433", "name": "aeron_db", "user": "aeron", "password": "aeron123", "schema": "aeron", "sslmode": "disable" },
            "image": { "target_width": 1280, "target_height": 1280, "quality": 90 },
            "api": { "enabled": false, "keys": [] }
          }
          EOF
          ./zwfm-aerontoolbox -config=test_no_auth.json -port=${{ env.API_PORT }} &
          echo $! > api.pid
          for i in {1..30}; do curl -sf http://localhost:${{ env.API_PORT }}/api/health > /dev/null 2>&1 && break; sleep 1; done
          echo "GET /api/artists (zonder API key, auth uitgeschakeld)"
          RESPONSE=$(curl -s http://localhost:${{ env.API_PORT }}/api/artists)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Correct: request zonder API key werkt als auth uitgeschakeld is"
          else
            echo "::error::Request zou moeten werken zonder auth als api.enabled=false"
            echo "Response: $RESPONSE"
            exit 1
          fi

      # ==================== ARTIST TESTS ====================
      - name: "Artist: Get statistics"
        if: matrix.suite == 'artists'
        run: |
          echo "GET /api/artists"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/artists)
          TOTAL=$(echo "$RESPONSE" | jq -r '.data.total')
          WITH_IMG=$(echo "$RESPONSE" | jq -r '.data.with_images')
          WITHOUT_IMG=$(echo "$RESPONSE" | jq -r '.data.without_images')
          echo "Totaal: $TOTAL (verwacht: 1000)"
          echo "Met afbeelding: $WITH_IMG (verwacht: >0)"
          echo "Zonder afbeelding: $WITHOUT_IMG (verwacht: >0)"
          FAILED=0
          [ "$TOTAL" -ne 1000 ] && echo "::error::Totaal aantal artiesten klopt niet" && FAILED=1
          [ "$WITH_IMG" -le 0 ] && echo "::error::Geen artiesten met afbeelding" && FAILED=1
          [ "$WITHOUT_IMG" -le 0 ] && echo "::error::Geen artiesten zonder afbeelding" && FAILED=1
          exit $FAILED

      - name: "Artist: Get single artist"
        if: matrix.suite == 'artists'
        run: |
          echo "GET /api/artists/${{ env.ARTIST_ID }}"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          ARTIST_NAME=$(echo "$RESPONSE" | jq -r '.data.artistname')
          if [ "$SUCCESS" = "true" ]; then
            echo "Artiest gevonden: $ARTIST_NAME"
          else
            echo "::error::Artiest niet gevonden"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Artist: Non-existent returns 404"
        if: matrix.suite == 'artists'
        run: |
          echo "GET /api/artists/${{ env.FAKE_UUID }} (niet-bestaande artiest)"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.FAKE_UUID }}")
          echo "HTTP status: $HTTP_CODE (verwacht: 404)"
          if [ "$HTTP_CODE" = "404" ]; then
            echo "Correct: niet-bestaande artiest geeft 404"
          else
            echo "::error::Verwachtte HTTP 404, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Artist: Upload image via URL"
        if: matrix.suite == 'artists'
        run: |
          echo "POST /api/artists/${{ env.ARTIST_ID }}/image (via URL)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' -m 15)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Afbeelding succesvol geupload via URL"
          else
            echo "::error::Upload via URL gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Artist: Upload image via base64"
        if: matrix.suite == 'artists'
        run: |
          echo "POST /api/artists/${{ env.BLOF_ID }}/image (via base64)"
          BASE64_IMAGE=$(base64 -w 0 < test_large.png)
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d "{\"image\":\"data:image/png;base64,$BASE64_IMAGE\"}")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Afbeelding succesvol geupload via base64"
          else
            echo "::error::Upload via base64 gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Artist: Get image"
        if: matrix.suite == 'artists'
        run: |
          echo "GET /api/artists/${{ env.BLOF_ID }}/image"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image")
          echo "HTTP status: $HTTP_CODE (verwacht: 200)"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Correct: afbeelding kan worden opgehaald"
          else
            echo "::error::Verwachtte HTTP 200, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Artist: Delete image"
        if: matrix.suite == 'artists'
        run: |
          echo "DELETE /api/artists/${{ env.BLOF_ID }}/image"
          RESPONSE=$(curl -s -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Afbeelding succesvol verwijderd"
          else
            echo "::error::Verwijderen van afbeelding gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Artist: Deleted image returns 404"
        if: matrix.suite == 'artists'
        run: |
          echo "GET /api/artists/${{ env.BLOF_ID }}/image (na verwijderen)"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image")
          echo "HTTP status: $HTTP_CODE (verwacht: 404)"
          if [ "$HTTP_CODE" = "404" ]; then
            echo "Correct: verwijderde afbeelding geeft 404"
          else
            echo "::error::Verwachtte HTTP 404, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Artist: Bulk delete requires confirmation"
        if: matrix.suite == 'artists'
        run: |
          echo "DELETE /api/artists/bulk-delete (zonder bevestiging)"
          RESPONSE=$(curl -s -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            http://localhost:${{ env.API_PORT }}/api/artists/bulk-delete)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: bulk delete zonder bevestiging wordt geweigerd"
          else
            echo "::error::Bulk delete zonder bevestiging zou geweigerd moeten worden"
            exit 1
          fi

      # ==================== TRACK TESTS ====================
      - name: "Track: Get statistics"
        if: matrix.suite == 'tracks'
        run: |
          echo "GET /api/tracks"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/tracks)
          TOTAL=$(echo "$RESPONSE" | jq -r '.data.total')
          echo "Totaal aantal tracks: $TOTAL (verwacht: 1100)"
          if [ "$TOTAL" -eq 1100 ]; then
            echo "Correct: $TOTAL tracks gevonden"
          else
            echo "::error::Verwachtte 1100 tracks, kreeg $TOTAL"
            exit 1
          fi
          # Save TRACK_ID for subsequent tests
          TRACK_ID=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT titleid FROM aeron.track LIMIT 1;" | tr -d ' ')
          echo "TRACK_ID=$TRACK_ID" >> $GITHUB_ENV
          echo "Test track ID: $TRACK_ID"

      - name: "Track: Get single track"
        if: matrix.suite == 'tracks'
        run: |
          echo "GET /api/tracks/${{ env.TRACK_ID }}"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          TITLE=$(echo "$RESPONSE" | jq -r '.data.title')
          if [ "$SUCCESS" = "true" ]; then
            echo "Track gevonden: $TITLE"
          else
            echo "::error::Track niet gevonden"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Track: Non-existent returns 404"
        if: matrix.suite == 'tracks'
        run: |
          echo "GET /api/tracks/${{ env.FAKE_UUID }} (niet-bestaande track)"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.FAKE_UUID }}")
          echo "HTTP status: $HTTP_CODE (verwacht: 404)"
          if [ "$HTTP_CODE" = "404" ]; then
            echo "Correct: niet-bestaande track geeft 404"
          else
            echo "::error::Verwachtte HTTP 404, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Track: Upload image"
        if: matrix.suite == 'tracks'
        run: |
          echo "POST /api/tracks/${{ env.TRACK_ID }}/image"
          BASE64_IMAGE=$(base64 -w 0 < test_large.png)
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d "{\"image\":\"data:image/png;base64,$BASE64_IMAGE\"}")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Afbeelding succesvol geupload naar track"
          else
            echo "::error::Track image upload gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Track: Get image"
        if: matrix.suite == 'tracks'
        run: |
          echo "GET /api/tracks/${{ env.TRACK_ID }}/image"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}/image")
          echo "HTTP status: $HTTP_CODE (verwacht: 200)"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Correct: track afbeelding kan worden opgehaald"
          else
            echo "::error::Verwachtte HTTP 200, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Track: Delete image"
        if: matrix.suite == 'tracks'
        run: |
          echo "DELETE /api/tracks/${{ env.TRACK_ID }}/image"
          RESPONSE=$(curl -s -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}/image")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Track afbeelding succesvol verwijderd"
          else
            echo "::error::Verwijderen van track afbeelding gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      # ==================== MAINTENANCE TESTS ====================
      - name: "Maintenance: Database health endpoint"
        if: matrix.suite == 'maintenance'
        run: |
          echo "GET /api/db/health"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/health)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          DB_NAME=$(echo "$RESPONSE" | jq -r '.data.database_name')
          if [ "$SUCCESS" = "true" ]; then
            echo "Database health OK - database: $DB_NAME"
          else
            echo "::error::Database health check gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Maintenance: Vacuum dry-run"
        if: matrix.suite == 'maintenance'
        run: |
          echo "POST /api/db/vacuum (dry_run=true)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"dry_run": true}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          DRY_RUN=$(echo "$RESPONSE" | jq -r '.data.dry_run')
          if [ "$SUCCESS" = "true" ] && [ "$DRY_RUN" = "true" ]; then
            echo "Vacuum dry-run succesvol"
          else
            echo "::error::Vacuum dry-run gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Maintenance: Vacuum specific table"
        if: matrix.suite == 'maintenance'
        run: |
          echo "POST /api/db/vacuum (table=artist, dry_run=true)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["artist"], "dry_run": true}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          TABLES_TOTAL=$(echo "$RESPONSE" | jq -r '.data.tables_total')
          if [ "$SUCCESS" = "true" ] && [ "$TABLES_TOTAL" = "1" ]; then
            echo "Vacuum voor specifieke tabel succesvol - $TABLES_TOTAL tabel(len)"
          else
            echo "::error::Vacuum voor specifieke tabel gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Maintenance: Vacuum with analyze"
        if: matrix.suite == 'maintenance'
        run: |
          echo "POST /api/db/vacuum (table=track, analyze=true, dry_run=true)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["track"], "analyze": true, "dry_run": true}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Vacuum met analyze succesvol"
          else
            echo "::error::Vacuum met analyze gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Maintenance: Non-existent table skipped"
        if: matrix.suite == 'maintenance'
        run: |
          echo "POST /api/db/vacuum (table=nonexistent_table)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["nonexistent_table"], "dry_run": true}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          SKIPPED=$(echo "$RESPONSE" | jq -r '.data.tables_skipped')
          if [ "$SUCCESS" = "true" ] && [ "$SKIPPED" = "1" ]; then
            echo "Correct: niet-bestaande tabel wordt overgeslagen ($SKIPPED)"
          else
            echo "::error::Niet-bestaande tabel zou overgeslagen moeten worden"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Maintenance: Analyze endpoint"
        if: matrix.suite == 'maintenance'
        run: |
          echo "POST /api/db/analyze (table=artist)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/analyze \
            -d '{"tables": ["artist"]}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Analyze succesvol uitgevoerd"
          else
            echo "::error::Analyze gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Maintenance: Execute actual vacuum"
        if: matrix.suite == 'maintenance'
        run: |
          echo "POST /api/db/vacuum (table=artist, analyze=true)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["artist"], "analyze": true}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          TABLES_SUCCESS=$(echo "$RESPONSE" | jq -r '.data.tables_success')
          if [ "$SUCCESS" = "true" ] && [ "$TABLES_SUCCESS" -ge 1 ]; then
            echo "Vacuum succesvol uitgevoerd op $TABLES_SUCCESS tabel(len)"
          else
            echo "::error::Vacuum uitvoering gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      # ==================== BACKUP TESTS ====================
      - name: "Backup: List backups (empty)"
        if: matrix.suite == 'backup'
        run: |
          echo "GET /api/db/backups"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backups)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          COUNT=$(echo "$RESPONSE" | jq -r '.data.total_count')
          if [ "$SUCCESS" = "true" ] && [ "$COUNT" = "0" ]; then
            echo "Correct: geen backups aanwezig ($COUNT)"
          else
            echo "::error::Verwachtte 0 backups, kreeg $COUNT"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Backup: Status endpoint (no backup yet)"
        if: matrix.suite == 'backup'
        run: |
          echo "GET /api/db/backup/status"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backup/status)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          RUNNING=$(echo "$RESPONSE" | jq -r '.data.running')
          if [ "$SUCCESS" = "true" ] && [ "$RUNNING" = "false" ]; then
            echo "Correct: geen backup actief"
          else
            echo "::error::Status endpoint gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Backup: Create async (custom format)"
        if: matrix.suite == 'backup'
        run: |
          echo "POST /api/db/backup (format=custom, compression=6)"
          HTTP_CODE=$(curl -s -o /tmp/backup_response.json -w "%{http_code}" -X POST \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "custom", "compression": 6}')
          RESPONSE=$(cat /tmp/backup_response.json)
          echo "HTTP status: $HTTP_CODE (verwacht: 202)"
          echo "Response: $RESPONSE"
          if [ "$HTTP_CODE" = "202" ]; then
            echo "Backup gestart op achtergrond"
          else
            echo "::error::Verwachtte HTTP 202 Accepted, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Backup: Wait for completion and verify status"
        if: matrix.suite == 'backup'
        run: |
          echo "Wachten op backup voltooiing..."
          for i in {1..60}; do
            RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backup/status)
            RUNNING=$(echo "$RESPONSE" | jq -r '.data.running')
            if [ "$RUNNING" = "false" ]; then
              SUCCESS_STATUS=$(echo "$RESPONSE" | jq -r '.data.success')
              FILENAME=$(echo "$RESPONSE" | jq -r '.data.filename')
              STARTED_AT=$(echo "$RESPONSE" | jq -r '.data.started_at')
              ENDED_AT=$(echo "$RESPONSE" | jq -r '.data.ended_at')
              ERROR=$(echo "$RESPONSE" | jq -r '.data.error')
              echo "Status response: $RESPONSE"
              if [ "$SUCCESS_STATUS" = "true" ] && [ "$STARTED_AT" != "null" ] && [ "$ENDED_AT" != "null" ]; then
                echo "Backup voltooid: $FILENAME (started: $STARTED_AT, ended: $ENDED_AT)"
                echo "BACKUP_FILENAME=$FILENAME" >> $GITHUB_ENV
                exit 0
              elif [ "$SUCCESS_STATUS" = "true" ]; then
                echo "::error::Backup success maar started_at of ended_at ontbreekt"
                exit 1
              else
                echo "::error::Backup gefaald: $ERROR"
                exit 1
              fi
            fi
            echo "Backup nog bezig... ($i/60)"
            sleep 1
          done
          echo "::error::Backup timeout na 60 seconden"
          exit 1

      - name: "Backup: Concurrent backup rejected"
        if: matrix.suite == 'backup'
        run: |
          echo "POST /api/db/backup (tweede backup starten terwijl eerste draait)"
          # Start eerste backup
          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "plain"}' > /dev/null

          # Poll status en probeer tweede backup zodra eerste draait
          TESTED=false
          for i in {1..60}; do
            RUNNING=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backup/status | jq -r '.data.running')
            if [ "$RUNNING" = "true" ]; then
              echo "Eerste backup draait, probeer tweede te starten..."
              RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
                -H 'Content-Type: application/json' \
                http://localhost:${{ env.API_PORT }}/api/db/backup \
                -d '{"format": "plain"}')
              SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
              ERROR=$(echo "$RESPONSE" | jq -r '.error')
              if [ "$SUCCESS" = "false" ] && echo "$ERROR" | grep -q "al bezig"; then
                echo "Correct: tweede backup wordt geweigerd"
                TESTED=true
                break
              else
                echo "::error::Tweede backup zou geweigerd moeten worden"
                echo "Response: $RESPONSE"
                exit 1
              fi
            fi
            sleep 0.1
          done

          if [ "$TESTED" = "false" ]; then
            echo "::error::Kon concurrent backup test niet uitvoeren (backup te snel klaar)"
            exit 1
          fi

          # Wacht tot backup klaar is
          for i in {1..60}; do
            RUNNING=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backup/status | jq -r '.data.running')
            [ "$RUNNING" = "false" ] && break
            sleep 1
          done

      - name: "Backup: List backups (2 files)"
        if: matrix.suite == 'backup'
        run: |
          echo "GET /api/db/backups"
          RESPONSE=$(curl -s -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backups)
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          COUNT=$(echo "$RESPONSE" | jq -r '.data.total_count')
          if [ "$SUCCESS" = "true" ] && [ "$COUNT" = "2" ]; then
            echo "Correct: $COUNT backups aanwezig"
          else
            echo "::error::Verwachtte 2 backups, kreeg $COUNT"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Backup: Download file"
        if: matrix.suite == 'backup'
        run: |
          echo "GET /api/db/backups/${{ env.BACKUP_FILENAME }}"
          HTTP_CODE=$(curl -s -o /tmp/backup.dump -w "%{http_code}" \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/${{ env.BACKUP_FILENAME }}")
          FILE_SIZE=$(stat -c%s /tmp/backup.dump 2>/dev/null || echo "0")
          echo "HTTP status: $HTTP_CODE, bestandsgrootte: $FILE_SIZE bytes"
          if [ "$HTTP_CODE" = "200" ] && [ "$FILE_SIZE" -gt 0 ]; then
            echo "Backup succesvol gedownload"
          else
            echo "::error::Backup download gefaald - HTTP $HTTP_CODE, grootte $FILE_SIZE"
            exit 1
          fi

      - name: "Backup: Delete without confirmation rejected"
        if: matrix.suite == 'backup'
        run: |
          echo "DELETE /api/db/backups/${{ env.BACKUP_FILENAME }} (zonder bevestiging)"
          RESPONSE=$(curl -s -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/${{ env.BACKUP_FILENAME }}")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: delete zonder bevestiging wordt geweigerd"
          else
            echo "::error::Delete zonder bevestiging zou geweigerd moeten worden"
            exit 1
          fi

      - name: "Backup: Delete with confirmation"
        if: matrix.suite == 'backup'
        run: |
          echo "DELETE /api/db/backups/${{ env.BACKUP_FILENAME }} (met bevestiging)"
          RESPONSE=$(curl -s -X DELETE \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H "X-Confirm-Delete: ${{ env.BACKUP_FILENAME }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/${{ env.BACKUP_FILENAME }}")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "Backup succesvol verwijderd"
          else
            echo "::error::Backup verwijderen gefaald"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Backup: Non-existent returns 404"
        if: matrix.suite == 'backup'
        run: |
          echo "DELETE /api/db/backups/aeron-backup-nonexistent.dump"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H "X-Confirm-Delete: aeron-backup-nonexistent.dump" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/aeron-backup-nonexistent.dump")
          echo "HTTP status: $HTTP_CODE (verwacht: 404)"
          if [ "$HTTP_CODE" = "404" ]; then
            echo "Correct: niet-bestaande backup geeft 404"
          else
            echo "::error::Verwachtte HTTP 404, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Backup: Invalid format rejected"
        if: matrix.suite == 'backup'
        run: |
          echo "POST /api/db/backup (format=invalid)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "invalid"}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: ongeldig format wordt geweigerd"
          else
            echo "::error::Ongeldig format zou geweigerd moeten worden"
            exit 1
          fi

      - name: "Backup: Invalid compression rejected"
        if: matrix.suite == 'backup'
        run: |
          echo "POST /api/db/backup (compression=15)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"compression": 15}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: ongeldige compressie (15) wordt geweigerd"
          else
            echo "::error::Ongeldige compressie zou geweigerd moeten worden"
            exit 1
          fi

      - name: "Backup: Path traversal blocked"
        if: matrix.suite == 'backup'
        run: |
          echo "DELETE /api/db/backups/../../../etc/passwd (path traversal poging)"
          RESPONSE=$(curl -s -X DELETE \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H "X-Confirm-Delete: ../../../etc/passwd" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/../../../etc/passwd")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: path traversal wordt geblokkeerd"
          else
            echo "::error::Path traversal zou geblokkeerd moeten worden!"
            exit 1
          fi

      # ==================== EDGE CASE TESTS ====================
      - name: "Edge: Upload to non-existent artist"
        if: matrix.suite == 'edge-cases'
        run: |
          echo "POST /api/artists/${{ env.FAKE_UUID }}/image (niet-bestaande artiest)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.FAKE_UUID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/500"}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "false" ]; then
            echo "Correct: upload naar niet-bestaande artiest wordt geweigerd"
          else
            echo "::error::Upload naar niet-bestaande artiest zou moeten falen"
            exit 1
          fi

      - name: "Edge: Invalid UUID returns 400"
        if: matrix.suite == 'edge-cases'
        run: |
          echo "POST /api/artists/not-a-uuid/image (ongeldige UUID)"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/not-a-uuid/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/500"}')
          echo "HTTP status: $HTTP_CODE (verwacht: 400)"
          if [ "$HTTP_CODE" = "400" ]; then
            echo "Correct: ongeldige UUID geeft 400 Bad Request"
          else
            echo "::error::Verwachtte HTTP 400, kreeg $HTTP_CODE"
            exit 1
          fi

      - name: "Edge: No image source rejected"
        if: matrix.suite == 'edge-cases'
        run: |
          echo "POST /api/artists/${{ env.ARTIST_ID }}/image (geen afbeelding meegegeven)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          ERROR=$(echo "$RESPONSE" | jq -r '.error')
          if [ "$SUCCESS" = "false" ] && echo "$ERROR" | grep -q 'afbeelding is verplicht'; then
            echo "Correct: request zonder afbeelding wordt geweigerd"
            echo "Foutmelding: $ERROR"
          else
            echo "::error::Request zonder afbeelding zou geweigerd moeten worden met juiste foutmelding"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Edge: Both URL and image rejected"
        if: matrix.suite == 'edge-cases'
        run: |
          echo "POST /api/artists/${{ env.ARTIST_ID }}/image (zowel URL als image)"
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://example.com/img.jpg","image":"data:image/jpeg;base64,/9j/4AAQ"}')
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          ERROR=$(echo "$RESPONSE" | jq -r '.error')
          if [ "$SUCCESS" = "false" ] && echo "$ERROR" | grep -q 'gebruik óf URL óf upload, niet beide'; then
            echo "Correct: zowel URL als image wordt geweigerd"
            echo "Foutmelding: $ERROR"
          else
            echo "::error::Request met zowel URL als image zou geweigerd moeten worden"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: "Edge: Concurrent uploads"
        if: matrix.suite == 'edge-cases'
        run: |
          echo "Testen van 3 gelijktijdige uploads..."
          ARTIST_ID2=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT artistid FROM aeron.artist OFFSET 1 LIMIT 1;" | tr -d ' ')
          TRACK_ID=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT titleid FROM aeron.track LIMIT 1;" | tr -d ' ')
          echo "Artist 1: ${{ env.ARTIST_ID }}"
          echo "Artist 2: $ARTIST_ID2"
          echo "Track: $TRACK_ID"

          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' > /tmp/r1.json &

          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${ARTIST_ID2}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' > /tmp/r2.json &

          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${TRACK_ID}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' > /tmp/r3.json &

          wait
          echo "Upload 1: $(cat /tmp/r1.json | jq -r '.success')"
          echo "Upload 2: $(cat /tmp/r2.json | jq -r '.success')"
          echo "Upload 3: $(cat /tmp/r3.json | jq -r '.success')"

          FAILED=0
          jq -e '.success == true' /tmp/r1.json > /dev/null || FAILED=1
          jq -e '.success == true' /tmp/r2.json > /dev/null || FAILED=1
          jq -e '.success == true' /tmp/r3.json > /dev/null || FAILED=1

          if [ "$FAILED" = "0" ]; then
            echo "Alle 3 gelijktijdige uploads succesvol"
          else
            echo "::error::Een of meer gelijktijdige uploads gefaald"
            exit 1
          fi

      # ==================== CLEANUP ====================
      - name: Stop API server
        if: always()
        run: |
          [ -f api.pid ] && kill $(cat api.pid) 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: |
          cd tests && docker compose -f docker-compose.test.yml down -v 2>/dev/null || true
          rm -f test_*.png test_*.json /tmp/r*.json /tmp/backup*.dump 2>/dev/null || true
