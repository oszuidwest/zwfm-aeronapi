name: Comprehensive Test
permissions:
  contents: read
on:
  workflow_call:
    inputs:
      skip_tests:
        description: 'Skip tests (for edge releases)'
        type: boolean
        required: false
        default: false
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (for edge releases)'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  POSTGRES_USER: aeron
  POSTGRES_PASSWORD: aeron123
  POSTGRES_DB: aeron_db
  API_PORT: 8888
  DB_PORT: 5433
  API_KEY: test-api-key-12345
  # Known IDs from test fixtures
  ARTIST_ID: "9e37ff1f-7823-43ce-93d0-12fc1c2edb8b"
  BLOF_ID: "add55a6e-2068-4114-b82a-e0729881f0be"
  FAKE_UUID: "00000000-0000-4000-8000-000000000001"

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build application
        run: |
          go build -ldflags="-X main.Version=test -X main.Commit=${{ github.sha }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o zwfm-aerontoolbox .
          ./zwfm-aerontoolbox -version

      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: binary
          path: zwfm-aerontoolbox
          retention-days: 1

  lint:
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Check formatting (gofmt)
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "De volgende bestanden zijn niet geformatteerd:"
            gofmt -s -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

      - name: Check for dead code
        run: go run golang.org/x/tools/cmd/deadcode@latest ./...

  integration:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}
    strategy:
      fail-fast: false
      matrix:
        suite:
          - database
          - api-basic
          - artists
          - tracks
          - maintenance
          - backup
          - edge-cases

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download binary
        uses: actions/download-artifact@v7
        with:
          name: binary

      - name: Make binary executable
        run: chmod +x ./zwfm-aerontoolbox

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq imagemagick postgresql-client

      - name: Start test database
        run: |
          cd tests
          docker compose -f docker-compose.test.yml up -d

      - name: Wait for database
        run: |
          for i in {1..30}; do
            if docker exec aeron-test-db pg_isready -U aeron 2>/dev/null; then
              sleep 2
              break
            fi
            sleep 1
          done
          ARTIST_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist;" 2>/dev/null | tr -d ' ')
          [ -n "$ARTIST_COUNT" ] && [ "$ARTIST_COUNT" -gt 0 ]

      - name: Create test configuration
        run: |
          cat > test_config.json << 'EOF'
          {
            "database": {
              "host": "localhost",
              "port": "5433",
              "name": "aeron_db",
              "user": "aeron",
              "password": "aeron123",
              "schema": "aeron",
              "sslmode": "disable"
            },
            "image": {
              "target_width": 1280,
              "target_height": 1280,
              "quality": 90,
              "reject_smaller": true
            },
            "api": {
              "enabled": true,
              "keys": ["test-api-key-12345", "another-test-key-67890"]
            },
            "backup": {
              "enabled": true,
              "path": "/tmp/backups",
              "retention_days": 30,
              "max_backups": 5,
              "default_format": "custom",
              "default_compression": 9
            }
          }
          EOF
          mkdir -p /tmp/backups

      - name: Create test images
        if: matrix.suite == 'artists' || matrix.suite == 'tracks' || matrix.suite == 'edge-cases'
        run: |
          convert -size 100x100 xc:red test_small.png
          convert -size 2000x2000 xc:blue test_large.png

      - name: Start API server
        run: |
          ./zwfm-aerontoolbox -config=test_config.json -port=${{ env.API_PORT }} &
          echo $! > api.pid
          for i in {1..30}; do
            curl -sf http://localhost:${{ env.API_PORT }}/api/health > /dev/null 2>&1 && break
            sleep 1
          done

      # ==================== DATABASE TESTS ====================
      - name: "Database: Schema exists"
        if: matrix.suite == 'database'
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db \
            -c "SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'aeron';" | grep -q 'aeron'

      - name: "Database: Required tables exist"
        if: matrix.suite == 'database'
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db \
            -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'aeron' AND table_name = 'artist';" | grep -q 'artist'
          docker exec aeron-test-db psql -U aeron -d aeron_db \
            -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'aeron' AND table_name = 'track';" | grep -q 'track'

      - name: "Database: Verify data counts"
        if: matrix.suite == 'database'
        run: |
          ARTIST_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist;" | tr -d ' ')
          TRACK_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.track;" | tr -d ' ')
          ARTISTS_WITH_IMG=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist WHERE picture IS NOT NULL;" | tr -d ' ')
          [ "$ARTIST_COUNT" -eq 1000 ]
          [ "$TRACK_COUNT" -eq 1100 ]
          [ "$ARTISTS_WITH_IMG" -gt 0 ]

      # ==================== API BASIC TESTS ====================
      - name: "API: Health endpoint"
        if: matrix.suite == 'api-basic'
        run: |
          RESPONSE=$(curl -sf http://localhost:${{ env.API_PORT }}/api/health)
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "API: Authentication required"
        if: matrix.suite == 'api-basic'
        run: |
          RESPONSE=$(curl -s http://localhost:${{ env.API_PORT }}/api/artists)
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      - name: "API: Valid API key accepted"
        if: matrix.suite == 'api-basic'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/artists)
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "API: Invalid API key rejected"
        if: matrix.suite == 'api-basic'
        run: |
          RESPONSE=$(curl -s -H 'X-API-Key: invalid-key' http://localhost:${{ env.API_PORT }}/api/artists)
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      - name: "API: Method not allowed returns 405"
        if: matrix.suite == 'api-basic'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/artists)
          [ "$HTTP_CODE" = "405" ]

      - name: "API: Invalid endpoint returns 404"
        if: matrix.suite == 'api-basic'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/invalid)
          [ "$HTTP_CODE" = "404" ]

      - name: "API: Playlist endpoint"
        if: matrix.suite == 'api-basic'
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db -c "UPDATE aeron.playlistitem SET startdatetime = CURRENT_DATE + (startdatetime::time)" > /dev/null
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/playlist)
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "API: Playlist block structure"
        if: matrix.suite == 'api-basic'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/playlist)
          echo "$RESPONSE" | jq -e '.data[0] | has("blockid") and has("name") and has("start_time") and has("end_time") and has("date") and has("tracks")' > /dev/null

      - name: "API: Playlist track structure"
        if: matrix.suite == 'api-basic'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/playlist)
          echo "$RESPONSE" | jq -e '.data[0].tracks[0] | has("trackid") and has("tracktitle") and has("artistid") and has("artistname") and has("start_time")' > /dev/null

      - name: "API: Auth disabled mode"
        if: matrix.suite == 'api-basic'
        run: |
          kill $(cat api.pid) 2>/dev/null || true
          cat > test_no_auth.json << 'EOF'
          {
            "database": { "host": "localhost", "port": "5433", "name": "aeron_db", "user": "aeron", "password": "aeron123", "schema": "aeron", "sslmode": "disable" },
            "image": { "target_width": 1280, "target_height": 1280, "quality": 90 },
            "api": { "enabled": false, "keys": [] }
          }
          EOF
          ./zwfm-aerontoolbox -config=test_no_auth.json -port=${{ env.API_PORT }} &
          echo $! > api.pid
          for i in {1..30}; do curl -sf http://localhost:${{ env.API_PORT }}/api/health > /dev/null 2>&1 && break; sleep 1; done
          RESPONSE=$(curl -sf http://localhost:${{ env.API_PORT }}/api/artists)
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      # ==================== ARTIST TESTS ====================
      - name: "Artist: Get statistics"
        if: matrix.suite == 'artists'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/artists)
          TOTAL=$(echo "$RESPONSE" | jq '.data.total')
          WITH_IMAGES=$(echo "$RESPONSE" | jq '.data.with_images')
          WITHOUT_IMAGES=$(echo "$RESPONSE" | jq '.data.without_images')
          [ "$TOTAL" -eq 1000 ] && [ "$WITH_IMAGES" -gt 0 ] && [ "$WITHOUT_IMAGES" -gt 0 ]

      - name: "Artist: Get single artist"
        if: matrix.suite == 'artists'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}")
          echo "$RESPONSE" | jq -e '.success == true and .data.artistid != null' > /dev/null

      - name: "Artist: Non-existent returns 404"
        if: matrix.suite == 'artists'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.FAKE_UUID }}")
          [ "$HTTP_CODE" = "404" ]

      - name: "Artist: Upload image via URL"
        if: matrix.suite == 'artists'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' -m 15)
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Artist: Upload image via base64"
        if: matrix.suite == 'artists'
        run: |
          BASE64_IMAGE=$(base64 -w 0 < test_large.png)
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d "{\"image\":\"data:image/png;base64,$BASE64_IMAGE\"}")
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Artist: Get image"
        if: matrix.suite == 'artists'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image")
          [ "$HTTP_CODE" = "200" ]

      - name: "Artist: Delete image"
        if: matrix.suite == 'artists'
        run: |
          RESPONSE=$(curl -sf -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image")
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Artist: Deleted image returns 404"
        if: matrix.suite == 'artists'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.BLOF_ID }}/image")
          [ "$HTTP_CODE" = "404" ]

      - name: "Artist: Bulk delete requires confirmation"
        if: matrix.suite == 'artists'
        run: |
          RESPONSE=$(curl -s -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            http://localhost:${{ env.API_PORT }}/api/artists/bulk-delete)
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      # ==================== TRACK TESTS ====================
      - name: "Track: Get statistics"
        if: matrix.suite == 'tracks'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/tracks)
          TOTAL=$(echo "$RESPONSE" | jq '.data.total')
          [ "$TOTAL" -eq 1100 ]
          # Save TRACK_ID for subsequent tests
          TRACK_ID=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT titleid FROM aeron.track LIMIT 1;" | tr -d ' ')
          echo "TRACK_ID=$TRACK_ID" >> $GITHUB_ENV

      - name: "Track: Get single track"
        if: matrix.suite == 'tracks'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}")
          echo "$RESPONSE" | jq -e '.success == true and .data.titleid != null' > /dev/null

      - name: "Track: Non-existent returns 404"
        if: matrix.suite == 'tracks'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.FAKE_UUID }}")
          [ "$HTTP_CODE" = "404" ]

      - name: "Track: Upload image"
        if: matrix.suite == 'tracks'
        run: |
          BASE64_IMAGE=$(base64 -w 0 < test_large.png)
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d "{\"image\":\"data:image/png;base64,$BASE64_IMAGE\"}")
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Track: Get image"
        if: matrix.suite == 'tracks'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}/image")
          [ "$HTTP_CODE" = "200" ]

      - name: "Track: Delete image"
        if: matrix.suite == 'tracks'
        run: |
          RESPONSE=$(curl -sf -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${{ env.TRACK_ID }}/image")
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      # ==================== MAINTENANCE TESTS ====================
      - name: "Maintenance: Database health endpoint"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/health)
          echo "$RESPONSE" | jq -e '.success == true and .data.database_name != null' > /dev/null

      - name: "Maintenance: Vacuum dry-run"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"dry_run": true}')
          echo "$RESPONSE" | jq -e '.success == true and .data.dry_run == true' > /dev/null

      - name: "Maintenance: Vacuum specific table"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["artist"], "dry_run": true}')
          echo "$RESPONSE" | jq -e '.success == true and .data.tables_total == 1' > /dev/null

      - name: "Maintenance: Vacuum with analyze"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["track"], "analyze": true, "dry_run": true}')
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Maintenance: Non-existent table skipped"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["nonexistent_table"], "dry_run": true}')
          echo "$RESPONSE" | jq -e '.success == true and .data.tables_skipped == 1' > /dev/null

      - name: "Maintenance: Analyze endpoint"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/analyze \
            -d '{"tables": ["artist"]}')
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Maintenance: Execute actual vacuum"
        if: matrix.suite == 'maintenance'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/vacuum \
            -d '{"tables": ["artist"], "analyze": true}')
          echo "$RESPONSE" | jq -e '.success == true and .data.tables_success >= 1' > /dev/null

      # ==================== BACKUP TESTS ====================
      - name: "Backup: List backups (empty)"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backups)
          echo "$RESPONSE" | jq -e '.success == true and .data.total_count == 0' > /dev/null

      - name: "Backup: Dry-run"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "custom", "dry_run": true}')
          echo "$RESPONSE" | jq -e '.success == true and .data.dry_run == true' > /dev/null

      - name: "Backup: Create (custom format)"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "custom", "compression": 6}')
          echo "$RESPONSE" | jq -e '.success == true and .data.filename != null' > /dev/null
          echo "BACKUP_FILENAME=$(echo "$RESPONSE" | jq -r '.data.filename')" >> $GITHUB_ENV

      - name: "Backup: Create (plain SQL)"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -sf -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "plain"}')
          echo "$RESPONSE" | jq -e '.success == true and .data.format == "plain"' > /dev/null

      - name: "Backup: List backups (2 files)"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -sf -H "X-API-Key: ${{ env.API_KEY }}" http://localhost:${{ env.API_PORT }}/api/db/backups)
          echo "$RESPONSE" | jq -e '.success == true and .data.total_count == 2' > /dev/null

      - name: "Backup: Download file"
        if: matrix.suite == 'backup'
        run: |
          HTTP_CODE=$(curl -s -o /tmp/backup.dump -w "%{http_code}" \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/${{ env.BACKUP_FILENAME }}")
          [ "$HTTP_CODE" = "200" ] && [ -s /tmp/backup.dump ]

      - name: "Backup: Stream download"
        if: matrix.suite == 'backup'
        run: |
          HTTP_CODE=$(curl -s -o /tmp/backup_stream.dump -w "%{http_code}" \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backup/download?format=custom&compression=3")
          [ "$HTTP_CODE" = "200" ] && [ -s /tmp/backup_stream.dump ]

      - name: "Backup: Delete without confirmation rejected"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -s -X DELETE -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/${{ env.BACKUP_FILENAME }}")
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      - name: "Backup: Delete with confirmation"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -sf -X DELETE \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H "X-Confirm-Delete: ${{ env.BACKUP_FILENAME }}" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/${{ env.BACKUP_FILENAME }}")
          echo "$RESPONSE" | jq -e '.success == true' > /dev/null

      - name: "Backup: Non-existent returns 404"
        if: matrix.suite == 'backup'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H "X-Confirm-Delete: aeron-backup-nonexistent.dump" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/aeron-backup-nonexistent.dump")
          [ "$HTTP_CODE" = "404" ]

      - name: "Backup: Invalid format rejected"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"format": "invalid"}')
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      - name: "Backup: Invalid compression rejected"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            -H 'Content-Type: application/json' \
            http://localhost:${{ env.API_PORT }}/api/db/backup \
            -d '{"compression": 15, "dry_run": true}')
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      - name: "Backup: Path traversal blocked"
        if: matrix.suite == 'backup'
        run: |
          RESPONSE=$(curl -s -X DELETE \
            -H "X-API-Key: ${{ env.API_KEY }}" \
            -H "X-Confirm-Delete: ../../../etc/passwd" \
            "http://localhost:${{ env.API_PORT }}/api/db/backups/../../../etc/passwd")
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      # ==================== EDGE CASE TESTS ====================
      - name: "Edge: Upload to non-existent artist"
        if: matrix.suite == 'edge-cases'
        run: |
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.FAKE_UUID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/500"}')
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null

      - name: "Edge: Invalid UUID returns 400"
        if: matrix.suite == 'edge-cases'
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/not-a-uuid/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/500"}')
          [ "$HTTP_CODE" = "400" ]

      - name: "Edge: No image source rejected"
        if: matrix.suite == 'edge-cases'
        run: |
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{}')
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null
          echo "$RESPONSE" | jq -r '.error' | grep -q 'afbeelding is verplicht'

      - name: "Edge: Both URL and image rejected"
        if: matrix.suite == 'edge-cases'
        run: |
          RESPONSE=$(curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://example.com/img.jpg","image":"data:image/jpeg;base64,/9j/4AAQ"}')
          echo "$RESPONSE" | jq -e '.success == false' > /dev/null
          echo "$RESPONSE" | jq -r '.error' | grep -q 'gebruik óf URL óf upload, niet beide'

      - name: "Edge: Concurrent uploads"
        if: matrix.suite == 'edge-cases'
        run: |
          ARTIST_ID2=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT artistid FROM aeron.artist OFFSET 1 LIMIT 1;" | tr -d ' ')
          TRACK_ID=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT titleid FROM aeron.track LIMIT 1;" | tr -d ' ')

          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${{ env.ARTIST_ID }}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' > /tmp/r1.json &

          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/artists/${ARTIST_ID2}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' > /tmp/r2.json &

          curl -s -X POST -H "X-API-Key: ${{ env.API_KEY }}" \
            "http://localhost:${{ env.API_PORT }}/api/tracks/${TRACK_ID}/image" \
            -H 'Content-Type: application/json' \
            -d '{"url":"https://picsum.photos/1500"}' > /tmp/r3.json &

          wait
          jq -e '.success == true' /tmp/r1.json > /dev/null
          jq -e '.success == true' /tmp/r2.json > /dev/null
          jq -e '.success == true' /tmp/r3.json > /dev/null

      # ==================== CLEANUP ====================
      - name: Stop API server
        if: always()
        run: |
          [ -f api.pid ] && kill $(cat api.pid) 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: |
          cd tests && docker compose -f docker-compose.test.yml down -v 2>/dev/null || true
          rm -f test_*.png test_*.json /tmp/r*.json /tmp/backup*.dump 2>/dev/null || true
