name: Comprehensive Test
on:
  workflow_call:
  workflow_dispatch:
env:
  GO_VERSION: '1.24'
  POSTGRES_USER: aeron
  POSTGRES_PASSWORD: aeron123
  POSTGRES_DB: aeron_db
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

          # Install required tools
          sudo apt-get update
          sudo apt-get install -y jq imagemagick postgresql-client
      - name: Run formatters and linters
        run: |
          # Check formatting
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "The following files are not formatted:"
            gofmt -s -l .
            exit 1
          fi

          # Run go vet
          go vet ./...
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=5m
      - name: Build application
        run: |
          go build -ldflags="-X main.Version=test -X main.Commit=${{ github.sha }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o aeron-imgman .
          ./aeron-imgman -version
      - name: Start test database with Docker Compose
        run: |
          cd tests
          docker compose -f docker-compose.test.yml up -d

          # Wait for database (much faster with Docker Compose)
          for i in {1..10}; do
            if docker exec aeron-test-db pg_isready -U aeron; then
              echo "Database is ready!"
              break
            fi
            echo "Waiting for database..."
            sleep 1
          done

          # Database already has mock data loaded from the image
          # Give it extra time to fully initialize
          sleep 5
      - name: Create test images
        run: |
          convert -size 100x100 xc:red test_small.png
          convert -size 2000x2000 xc:blue test_large.png
          ls -la test_*.png
      - name: Create database reset function
        run: |
          # Create reusable function for database reset
          cat > reset_db.sh << 'EOF'
          #!/bin/bash
          echo "Resetting database with fresh mock data..."
          docker exec aeron-test-db psql -U aeron -d postgres -c "DROP DATABASE IF EXISTS aeron_db;"
          docker exec aeron-test-db psql -U aeron -d postgres -c "CREATE DATABASE aeron_db;"
          docker exec aeron-test-db psql -U aeron -d aeron_db -f /docker-entrypoint-initdb.d/01-mock-data.sql
          echo "Database reset complete"
          EOF
          chmod +x reset_db.sh
      # Database Integrity Tests (verify test infrastructure)
      - name: Database Test - Verify initial data setup
        run: |
          echo "Test: Controleer database test data"
          
          # Check if database initialization completed
          echo "Checking database initialization status..."
          docker exec aeron-test-db psql -U aeron -d aeron_db -c "\dt aeron.*" || true
          
          # Check for any errors in container logs
          echo "Recent container logs:"
          docker logs aeron-test-db 2>&1 | tail -50 | grep -E "(ERROR|FATAL|WARNING)" || true

          # Tel alle records
          ARTIST_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist;" | tr -d ' ')
          TRACK_COUNT=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.track;" | tr -d ' ')
          ARTISTS_WITH_IMG=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist WHERE picture IS NOT NULL;" | tr -d ' ')
          TRACKS_WITH_IMG=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.track WHERE picture IS NOT NULL;" | tr -d ' ')
          ARTISTS_WITHOUT_IMG=$(docker exec aeron-test-db psql -U aeron -d aeron_db -t -c "SELECT COUNT(*) FROM aeron.artist WHERE picture IS NULL;" | tr -d ' ')

          echo "Database inhoud:"
          echo "  Totaal artiesten: $ARTIST_COUNT (verwacht: 1000)"
          echo "  Artiesten met afbeelding: $ARTISTS_WITH_IMG"
          echo "  Artiesten zonder afbeelding: $ARTISTS_WITHOUT_IMG"
          echo "  Totaal tracks: $TRACK_COUNT (verwacht: 1100)"
          echo "  Tracks met afbeelding: $TRACKS_WITH_IMG"

          # Controleer verwachte aantallen
          ERRORS=0
          if [ "$ARTIST_COUNT" -eq 1000 ]; then
            echo "✓ Verwachtte 1000 artiesten, kreeg 1000 artiesten"
          else
            echo "✗ Verwachtte 1000 artiesten, kreeg $ARTIST_COUNT artiesten"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$TRACK_COUNT" -eq 1100 ]; then
            echo "✓ Verwachtte 1100 tracks, kreeg 1100 tracks"
          else
            echo "✗ Verwachtte 1100 tracks, kreeg $TRACK_COUNT tracks"
            ERRORS=$((ERRORS + 1))
          fi

          # Controleer dat er artiesten met en zonder afbeeldingen zijn
          if [ "$ARTISTS_WITH_IMG" -gt 0 ] && [ "$ARTISTS_WITHOUT_IMG" -gt 0 ]; then
            echo "✓ Database bevat artiesten met en zonder afbeeldingen"
          else
            echo "✗ Database moet artiesten met en zonder afbeeldingen bevatten"
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi
      - name: Database Test - Schema exists
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db \
            -c "SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'aeron';" | grep -q 'aeron'
      - name: Database Test - Artist table exists
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db \
            -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'aeron' AND table_name = 'artist';" | grep -q 'artist'
      - name: Database Test - Track table exists
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db \
            -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'aeron' AND table_name = 'track';" | grep -q 'track'
      - name: Create test configuration
        run: |
          # Create test config pointing to Docker container on port 5433
          cat > test_config.yaml << 'EOF'
          database:
            host: localhost
            port: "5433"
            name: aeron_db
            user: aeron
            password: aeron123
            schema: aeron
            sslmode: disable

          image:
            target_width: 1280
            target_height: 1280
            quality: 90
            reject_smaller: true

          api:
            enabled: true
            keys:
              - "test-api-key-12345"
              - "another-test-key-67890"
          EOF
      # API Tests
      - name: Reset database before API tests
        run: ./reset_db.sh
      - name: Start API server
        run: |
          ./aeron-imgman -config=test_config.yaml -port=8888 &
          echo $! > api.pid
          sleep 3
      - name: API Test - Health check
        run: |
          echo "Test: API health endpoint"
          RESPONSE=$(curl -s http://localhost:8888/api/health)
          if echo "$RESPONSE" | jq -e '.success == true' > /dev/null; then
            echo "✓ Health endpoint geeft success=true terug"
          else
            echo "✗ Verwachtte success=true maar kreeg:"
            echo "   $RESPONSE" | jq .
            exit 1
          fi
      - name: API Test - Artists statistics (default)
        run: |
          echo "Test: API artists endpoint geeft standaard statistieken"
          RESPONSE=$(curl -s -H 'X-API-Key: test-api-key-12345' 'http://localhost:8888/api/artists')
          TOTAL=$(echo "$RESPONSE" | jq '.data.total')
          WITH_IMAGES=$(echo "$RESPONSE" | jq '.data.with_images')
          WITHOUT_IMAGES=$(echo "$RESPONSE" | jq '.data.without_images')
          ORPHANED=$(echo "$RESPONSE" | jq '.data.orphaned')

          echo "Verwachtte: 1000 totaal, mix van met/zonder afbeeldingen, orphaned check"
          echo "Gekregen: $TOTAL totaal, $WITH_IMAGES met, $WITHOUT_IMAGES zonder, $ORPHANED orphaned"

          if [ "$TOTAL" -eq 1000 ] && [ "$WITH_IMAGES" -gt 0 ] && [ "$WITHOUT_IMAGES" -gt 0 ]; then
            echo "✓ API /artists endpoint geeft correcte statistieken"
          else
            echo "✗ Fout in statistieken:"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      - name: API Test - List artists (no auth)
        run: |
          echo "Test: API moet authenticatie vereisen"
          RESPONSE=$(curl -s 'http://localhost:8888/api/artists')
          if echo "$RESPONSE" | jq -e '.success == false' > /dev/null; then
            echo "✓ Verwachtte toegang geweigerd zonder API key, kreeg success=false"
          else
            echo "✗ API zou toegang moeten weigeren zonder API key"
            echo "   Response: $RESPONSE"
            exit 1
          fi
      - name: API Test - Artist image upload (URL)
        run: |
          echo "Test: Artist image upload via URL"
          RESPONSE=$(curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8888/api/artists/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"1 Purple Disco Machine","url":"https://picsum.photos/1500"}' \
            -m 10)
          echo "Response: $RESPONSE"
          echo "$RESPONSE" | jq -e '.success == true' || (echo "Upload failed" && exit 1)
      - name: API Test - Track image upload (base64)
        run: |
          echo "Test: Track image upload with base64 (too small image)"
          BASE64_IMAGE=$(base64 -w 0 < test_small.png)
          RESPONSE=$(curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8888/api/tracks/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"Als De Eerste Sneeuw Valt","image":"data:image/png;base64,'$BASE64_IMAGE'"}')
          echo "Response: $RESPONSE"
          echo "$RESPONSE" | jq -e '.success == false and (.error | contains("afbeelding te klein"))'
      - name: API Test - Bulk delete without confirmation
        run: |
          curl -s -X DELETE -H 'X-API-Key: test-api-key-12345' http://localhost:8888/api/artists/bulk-delete | jq -e '.success == false'
      - name: API Test - Method not allowed
        run: |
          curl -s -X PUT -H 'X-API-Key: test-api-key-12345' http://localhost:8888/api/artists | jq -e '.success == false'
      - name: API Test - Playlist endpoint
        run: |
          echo "Test: API playlist endpoint"
          # First update playlist dates to today
          docker exec aeron-test-db psql -U aeron -d aeron_db -c "UPDATE aeron.playlistitem SET startdatetime = CURRENT_DATE + (startdatetime::time)" >/dev/null

          RESPONSE=$(curl -s -H 'X-API-Key: test-api-key-12345' http://localhost:8888/api/playlist/today)
          SUCCESS=$(echo "$RESPONSE" | jq '.success')
          ITEM_COUNT=$(echo "$RESPONSE" | jq '.data | length')

          echo "Response success: $SUCCESS"
          echo "Playlist items: $ITEM_COUNT"
          if [ "$SUCCESS" = "true" ] && [ "$ITEM_COUNT" -gt 0 ]; then
            echo "✓ Playlist endpoint returned items"
            # Verify first item has required fields
            FIRST_ITEM=$(echo "$RESPONSE" | jq '.data[0]')
            if echo "$FIRST_ITEM" | jq -e 'has("songid") and has("songname") and has("artistid") and has("artistname") and has("start_time") and has("has_image")' > /dev/null; then
              echo "✓ Playlist items have correct structure"
            else
              echo "✗ Playlist items missing required fields"
              echo "$FIRST_ITEM" | jq .
              exit 1
            fi
          else
            echo "✗ Playlist endpoint failed or returned no items"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      - name: Stop API server
        run: |
          kill $(cat api.pid) || true
          rm -f api.pid
          sleep 1
      # Image Optimization Tests via API
      - name: Reset database before optimization tests
        run: ./reset_db.sh
      - name: Start API server for optimization tests
        run: |
          ./aeron-imgman -config=test_config.yaml -port=8892 &
          echo $! > api_opt.pid
          sleep 3
      - name: Image Optimization Test - Verify optimization via API
        run: |
          echo "Test: Afbeelding optimalisatie via API"
          echo "Upload grote afbeelding (2000x2000)"
          BASE64_IMAGE=$(base64 -w 0 < test_large.png)
          RESPONSE=$(curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8892/api/artists/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"1 BLØF","image":"data:image/png;base64,'$BASE64_IMAGE'"}')
          
          if echo "$RESPONSE" | jq -e '.success == true' > /dev/null; then
            echo "✓ Upload succesvol via API"
            echo "$RESPONSE" | jq .
          else
            echo "✗ Upload mislukt"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      - name: Stop API optimization server
        run: |
          kill $(cat api_opt.pid) || true
          rm -f api_opt.pid
      # Concurrent API Operations Test
      - name: Reset database before concurrent tests
        run: ./reset_db.sh
      - name: Start API server for concurrent tests
        run: |
          ./aeron-imgman -config=test_config.yaml -port=8893 &
          echo $! > api_concurrent.pid
          sleep 3
      - name: Concurrent API Operations Test
        run: |
          echo "Test: Gelijktijdige API uploads"
          echo "Start 3 uploads tegelijk via API"
          
          # Upload to multiple endpoints concurrently
          curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8893/api/artists/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"1 Purple Disco Machine","url":"https://picsum.photos/1500"}' > result1.json &
          PID1=$!
          
          curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8893/api/artists/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"1 BLØF","url":"https://picsum.photos/1500"}' > result2.json &
          PID2=$!
          
          curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8893/api/tracks/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"Als De Eerste Sneeuw Valt","url":"https://picsum.photos/1500"}' > result3.json &
          PID3=$!
          
          if wait $PID1 && wait $PID2 && wait $PID3; then
            echo "✓ Alle 3 gelijktijdige API uploads afgerond"
            # Check results
            for i in 1 2 3; do
              if jq -e '.success == true' result$i.json > /dev/null; then
                echo "✓ Upload $i succesvol"
              else
                echo "✗ Upload $i mislukt"
                cat result$i.json | jq .
                exit 1
              fi
            done
          else
            echo "✗ Een of meer uploads zijn mislukt"
            exit 1
          fi
      - name: Stop API concurrent server
        run: |
          kill $(cat api_concurrent.pid) || true
          rm -f api_concurrent.pid result*.json
      # Edge Cases and Error Handling via API
      - name: Reset database before edge case tests  
        run: ./reset_db.sh
      - name: Start API server for edge case tests
        run: |
          ./aeron-imgman -config=test_config.yaml -port=8894 &
          echo $! > api_edge.pid
          sleep 3
      - name: Edge Case Test - Non-existent artist via API
        run: |
          echo "Test: Upload naar niet-bestaande artiest via API"
          RESPONSE=$(curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8894/api/artists/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"NONEXISTENT_ARTIST_XYZ","url":"https://picsum.photos/500"}')
          
          if echo "$RESPONSE" | jq -e '.success == false' > /dev/null && echo "$RESPONSE" | jq -r '.error' | grep -q 'bestaat niet'; then
            echo "✓ Niet-bestaande artiest gaf verwachte fout"
          else
            echo "✗ Verwachtte 'bestaat niet' fout"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      - name: Edge Case Test - Both name and ID via API
        run: |
          RESPONSE=$(curl -s -X POST -H 'X-API-Key: test-api-key-12345' http://localhost:8894/api/artists/upload \
            -H 'Content-Type: application/json' \
            -d '{"name":"Test","id":"123e4567-e89b-12d3-a456-426614174000","url":"https://picsum.photos/500"}')
          
          if echo "$RESPONSE" | jq -e '.success == false' > /dev/null && echo "$RESPONSE" | jq -r '.error' | grep -q 'niet beide'; then
            echo "✓ Beide naam en ID gaf verwachte fout"
          else  
            echo "✗ Verwachtte 'niet beide' fout"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      - name: Stop API edge case server
        run: |
          kill $(cat api_edge.pid) || true
          rm -f api_edge.pid
      # API Authentication Tests
      - name: API Auth Test - Setup auth config
        run: |
          cat > test_auth_config.yaml << 'EOF'
          database:
            host: localhost
            port: "5433"
            name: aeron_db
            user: aeron
            password: aeron123
            schema: aeron
            sslmode: disable

          image:
            target_width: 1280
            target_height: 1280
            quality: 90
            reject_smaller: true

          api:
            enabled: true
            keys:
              - "test-api-key-12345"
              - "another-test-key-67890"
          EOF
      - name: API Auth Test - Start server with auth
        run: |
          ./aeron-imgman -config=test_auth_config.yaml -port=8890 &
          echo $! > api_auth.pid
          sleep 3
      - name: API Auth Test - Health endpoint (no auth required)
        run: |
          curl -s http://localhost:8890/api/health | jq -e '.success == true'
      - name: API Auth Test - Protected endpoint without API key
        run: |
          echo "Test: API endpoint zonder API key"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8890/api/artists)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if echo "$BODY" | jq -e '.success == false' > /dev/null; then
            echo "✓ Verwachtte weigering zonder API key, kreeg success=false"
          else
            echo "✗ API zou request moeten weigeren zonder API key"
            echo "   Response: $BODY"
            exit 1
          fi
      - name: API Auth Test - Protected endpoint with invalid API key
        run: |
          curl -s -H "X-API-Key: invalid-key" http://localhost:8890/api/artists | jq -e '.success == false'
      - name: API Auth Test - Protected endpoint with valid API key (header)
        run: |
          curl -s -H "X-API-Key: test-api-key-12345" http://localhost:8890/api/artists | jq -e '.success == true'
      - name: API Auth Test - Protected endpoint with valid API key (query param)
        run: |
          curl -s "http://localhost:8890/api/artists?key=another-test-key-67890" | jq -e '.success == true'
      - name: Stop API auth server
        run: |
          kill $(cat api_auth.pid) || true
          rm -f api_auth.pid
          sleep 1
      - name: API Auth Test - Setup no auth config
        run: |
          cat > test_no_auth_config.yaml << 'EOF'
          database:
            host: localhost
            port: "5433"
            name: aeron_db
            user: aeron
            password: aeron123
            schema: aeron
            sslmode: disable

          image:
            target_width: 1280
            target_height: 1280
            quality: 90
            reject_smaller: true

          api:
            enabled: false
            keys: []
          EOF
      - name: API Auth Test - Start server without auth
        run: |
          ./aeron-imgman -config=test_no_auth_config.yaml -port=8891 &
          echo $! > api_no_auth.pid
          sleep 3
      - name: API Auth Test - Protected endpoint with auth disabled
        run: |
          curl -s http://localhost:8891/api/artists | jq -e '.success == true'
      - name: Stop API no-auth server
        run: |
          kill $(cat api_no_auth.pid) || true
          rm -f api_no_auth.pid
      # Bulk Delete Tests via API
      - name: Reset database before bulk delete tests
        run: ./reset_db.sh
      - name: Start API server for bulk delete tests
        run: |
          ./aeron-imgman -config=test_config.yaml -port=8895 &
          echo $! > api_bulk.pid
          sleep 3
      - name: Bulk Delete Test - Without confirmation header
        run: |
          echo "Test: Bulk delete zonder bevestiging"
          RESPONSE=$(curl -s -X DELETE -H 'X-API-Key: test-api-key-12345' http://localhost:8895/api/artists/bulk-delete)
          
          if echo "$RESPONSE" | jq -e '.success == false' > /dev/null && echo "$RESPONSE" | jq -r '.error' | grep -q 'confirmation'; then
            echo "✓ Bulk delete geweigerd zonder confirmation header"
          else
            echo "✗ Verwachtte weigering zonder confirmation"
            echo "$RESPONSE" | jq .
            exit 1
          fi
      - name: Stop API bulk delete server
        run: |
          kill $(cat api_bulk.pid) || true
          rm -f api_bulk.pid
      # Cleanup
      - name: Cleanup test data
        run: |
          docker exec aeron-test-db psql -U aeron -d aeron_db -c "UPDATE aeron.artist SET picture = NULL WHERE artist LIKE 'TEST_%';"
          docker exec aeron-test-db psql -U aeron -d aeron_db -c "UPDATE aeron.track SET picture = NULL WHERE tracktitle LIKE 'TEST_%';"
          rm -f test_*.png test_*.yaml api*.pid

          # Stop and remove Docker containers
          cd tests && docker compose -f docker-compose.test.yml down -v
